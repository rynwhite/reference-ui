import { writeFileSync } from 'node:fs'
import { resolve } from 'node:path'
import { resolvePackageRoot } from './resolve-consumer.js'
import { loadReferenceConfig } from './load-config.js'
import { runPanda } from './run-panda.js'

const OUT_DIR = '.reference'
const DEFAULT_INCLUDE = [
  'src/**/*.{ts,tsx}',
  'node_modules/@reference-ui/core/**/*.{ts,tsx}',
]

function writePandaConfig(packageRoot: string, include: string[]): void {
  const configContent = `/** Generated by @reference-ui/cli - do not edit by hand */
import { createPandaConfig } from '@reference-ui/system'

export default createPandaConfig({
  cwd: process.cwd(),
  outDir: '${OUT_DIR}',
  include: ${JSON.stringify(include)},
})
`
  const configPath = resolve(packageRoot, 'panda.config.ts')
  writeFileSync(configPath, configContent, 'utf-8')
}

/**
 * Run sync: write panda.config.ts in the consumer package and run panda codegen + cssgen.
 * Output goes to the consumer's .reference/
 */
export function runSync(startCwd?: string): { ok: boolean; packageRoot: string } {
  const packageRoot = resolvePackageRoot(startCwd ?? process.cwd())
  const config = loadReferenceConfig(packageRoot)
  const include = config.include?.length ? config.include : DEFAULT_INCLUDE

  writePandaConfig(packageRoot, include)

  if (!runPanda(packageRoot, ['codegen'])) {
    return { ok: false, packageRoot }
  }

  const outFile = `${OUT_DIR}/panda.css`
  if (!runPanda(packageRoot, ['cssgen', '--outfile', outFile])) {
    return { ok: false, packageRoot }
  }

  return { ok: true, packageRoot }
}
